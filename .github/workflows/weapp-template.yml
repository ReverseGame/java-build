name: Weapp CI

on:
  workflow_call:
    inputs:
      projectName:
        required: true
        type: string
      buildStage:
        required: true
        type: string
      envRule:
        required: true
        type: string
      workDir:
        required: true
        type: string
      desc:
        required: false
        type: string
        default: "GitHub Actions è‡ªåŠ¨ä¸Šä¼ "
    secrets:
      webhookFeishu:
        required: true
      wechatPrivateKey:
        required: true
      wechatToolId:
        required: false
      appId:
        required: true

jobs:
  build_and_upload:
    environment: ${{ inputs.envRule }}
    runs-on: wechat-app
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: ğŸ“¨ æ„å»ºå¼€å§‹é€šçŸ¥
        uses: foxundermoon/feishu-action@v2
        with:
          url: ${{ secrets.webhookFeishu }}
          msg_type: post
          content: |
            post:
              zh_cn:
                title: "${{ inputs.projectName }} å°ç¨‹åºå¼€å§‹æ„å»º ğŸš€"
                content:
                  - - tag: text
                      text: "ç¯å¢ƒ: ${{ inputs.buildStage }}"
                  - - tag: text
                      text: "åˆ†æ”¯: ${{ github.ref }}"
                  - - tag: a
                      text: æŸ¥çœ‹è¿è¡Œè¯¦æƒ…
                      href: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - uses: actions/checkout@v3

      - name: ğŸ§© ç”Ÿæˆå”¯ä¸€ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d.%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ§± è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·: $VERSION"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - run: pnpm install

      - name: ğŸ—ï¸ æ„å»ºå¾®ä¿¡å°ç¨‹åº
        run: pnpm run build:mp-weixin
        working-directory: ${{ inputs.workDir }}

      - name: ğŸ§± ä¿å­˜å¾®ä¿¡å°ç¨‹åºç§é’¥
        run: |
          echo "${{ secrets.wechatPrivateKey }}" > private.key

      - name: ğŸš€ ä¸Šä¼ å°ç¨‹åºä»£ç 
        run: |
          npx miniprogram-ci upload \
            --pp ${{ inputs.workDir }}/dist/build/mp-weixin \
            --pkp private.key \
            --appid ${{ secrets.appId }} \
            --uv ${{ steps.version.outputs.version }} \
            -r 1 \
            --enable-es6 true \
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: ğŸ§¹ æ¸…ç†ç§é’¥
        if: always()
        run: rm -f private.key

      - name: âœ… ä¸Šä¼ å®Œæˆé€šçŸ¥
        uses: foxundermoon/feishu-action@v2
        if: ${{ always() }}
        with:
          url: ${{ secrets.webhookFeishu }}
          msg_type: post
          content: |
            post:
              zh_cn:
                title: "${{ inputs.projectName }} å°ç¨‹åºä¸Šä¼  ${{ job.status }}ï¼Œå»åå°å‘å¸ƒ ğŸ‰"
                content:
                  - - tag: text
                      text: "ç¯å¢ƒ: ${{ inputs.buildStage }}"
                  - - tag: text
                      text: "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
                  - - tag: a
                      text: æŸ¥çœ‹è¯¦æƒ…
                      href: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
