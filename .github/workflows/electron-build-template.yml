name: Electron Build Template

on:
    workflow_call:
        inputs:
            buildStage:
                description: "构建阶段: beta / product"
                required: true
                type: string
            runner:
                description: "构建使用的 Runner"
                required: false
                type: string
                default: "windows-latest"
            nodeVersion:
                description: "Node.js 版本"
                required: false
                type: string
                default: "18"
            pnpmVersion:
                description: "pnpm 版本"
                required: false
                type: string
                default: "8"
            awsRegion:
                description: "AWS 区域"
                required: true
                type: string
            bucket:
                description: "S3 Bucket 名称"
                required: true
                type: string
            awsPath:
                description: "S3 上传路径"
                required: true
                type: string
            buildFeishuWebhook:
                description: "构建通知飞书 Webhook"
                required: false
                type: string
            releaseFeishuWebhook:
                description: "发布通知飞书 Webhook"
                required: false
                type: string
            backendServerUrl:
                description: "后端服务器 URL"
                required: true
                type: string
            bypassApiUrl:
                description: "Bypass API URL"
                required: true
                type: string
        secrets:
            awsAccessKey:
                description: "AWS Access Key ID"
                required: true
            awsSecretKey:
                description: "AWS Secret Access Key"
                required: true
            patToken:
                description: "GitHub PAT Token"
                required: true

jobs:
    build-electron:
        outputs:
            product-info: ${{ steps.product-info.outputs.result }}
        runs-on: ${{ inputs.runner }}
        permissions:
            contents: write
            pull-requests: read
        steps:
            - name: Checkout code (检出代码)
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.patToken }}
                  fetch-depth: 0

            - name: Get Project Info
              id: product-info
              uses: actions/github-script@v7
              env:
                  BUILD_STAGE: ${{ inputs.buildStage }}
              with:
                  result-encoding: json
                  script: |
                      const packageJson = require('./package.json')
                      const version = packageJson.version
                      const productName = packageJson.name
                      const buildStage = process.env.BUILD_STAGE

                      console.log(`当前版本: ${version}`)
                      console.log(`产品名称: ${productName}`)
                      console.log(`构建阶段: ${buildStage}`)

                      return {
                        version,
                        productName,
                        buildStage
                      }

            - name: Get PR labels (获取 PR 标签)
              id: pr_labels
              if: inputs.buildStage == 'product'
              uses: actions/github-script@v7
              with:
                  result-encoding: string
                  script: |
                      // 获取触发此次构建的 PR 的 labels
                      try {
                        const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: context.sha
                        });

                        if (prs.length > 0) {
                          const labels = prs[0].labels.map(l => l.name);
                          console.log(`PR Labels: ${labels.join(', ')}`);
                          if (labels.includes('version:major')) return 'major';
                          if (labels.includes('version:minor')) return 'minor';
                        }
                      } catch (error) {
                        console.log(`获取 PR labels 失败: ${error.message}`);
                      }
                      return 'patch';

            - name: Increment version (版本号递增 - 仅 Production)
              id: version
              if: inputs.buildStage == 'product'
              uses: actions/github-script@v7
              env:
                  VERSION_TYPE: ${{ steps.pr_labels.outputs.result }}
                  GH_TOKEN: ${{ github.token }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
              with:
                  script: |
                      const fs = require('fs')
                      const { execSync } = require('child_process')

                      const packageJson = require('./package.json')
                      const currentVersion = packageJson.version
                      const versionType = process.env.VERSION_TYPE || 'patch'

                      // 移除可能的 beta/alpha 后缀
                      const baseVersion = currentVersion.replace(/-[a-z]*\.[0-9]*/, '')

                      // 解析版本号
                      const [major, minor, patch] = baseVersion.split('.').map(Number)

                      // 根据 PR label 决定递增类型
                      let newVersion
                      switch (versionType) {
                        case 'major':
                          newVersion = `${major + 1}.0.0`
                          break
                        case 'minor':
                          newVersion = `${major}.${minor + 1}.0`
                          break
                        default:
                          newVersion = `${major}.${minor}.${patch + 1}`
                      }

                      core.setOutput('NEW_VERSION', newVersion)
                      console.log(`版本号更新: ${currentVersion} → ${newVersion} (${versionType})`)

                      // 更新 package.json
                      execSync(`npm version ${newVersion} --no-git-tag-version`, { stdio: 'inherit' })

                      // 提交版本更新
                      execSync('git config user.name "github-actions[bot]"', { stdio: 'inherit' })
                      execSync('git config user.email "github-actions[bot]@users.noreply.github.com"', { stdio: 'inherit' })
                      execSync('git add package.json', { stdio: 'inherit' })
                      execSync(`git commit -m "chore: bump version to ${newVersion} [skip ci]"`, { stdio: 'inherit' })

                      // 使用 GITHUB_TOKEN 显式设置远程 URL 以确保推送权限
                      const token = process.env.GH_TOKEN
                      const repo = process.env.GITHUB_REPOSITORY
                      execSync(`git remote set-url origin https://x-access-token:${token}@github.com/${repo}.git`, { stdio: 'inherit' })
                      execSync('git push', { stdio: 'inherit' })

            - name: Get current version (获取当前版本 - Beta)
              id: version_beta
              if: inputs.buildStage == 'beta'
              uses: actions/github-script@v7
              with:
                  script: |
                      const version = require('./package.json').version
                      core.setOutput('NEW_VERSION', version)
                      console.log(`Beta 使用当前版本: ${version}`)

            - name: Set final version
              id: final_version
              uses: actions/github-script@v7
              env:
                  BUILD_STAGE: ${{ inputs.buildStage }}
                  VERSION_PRODUCT: ${{ steps.version.outputs.NEW_VERSION }}
                  VERSION_BETA: ${{ steps.version_beta.outputs.NEW_VERSION }}
              with:
                  script: |
                      const buildStage = process.env.BUILD_STAGE
                      const finalVersion = buildStage === 'product'
                        ? process.env.VERSION_PRODUCT
                        : process.env.VERSION_BETA
                      core.setOutput('FINAL_VERSION', finalVersion)
                      console.log(`最终版本: ${finalVersion}`)

            - uses: actions/github-script@v7
              id: message-content
              env:
                  RUN_ID: ${{ github.run_id }}
                  SERVER_URL: ${{ github.server_url }}
                  REPOSITORY: ${{ github.repository }}
              with:
                  result-encoding: json
                  script: |
                      const gh = {
                        server_url: process.env.SERVER_URL,
                        repository: process.env.REPOSITORY,
                        run_id: process.env.RUN_ID
                      }
                      return `**构建链接**\n[点击查看 Actions](${gh.server_url}/${gh.repository}/actions/runs/${gh.run_id})`

            - name: Post Build Start Message (发送构建开始飞书通知)
              uses: Comori/feishu@v0.0.5
              if: success() && inputs.buildFeishuWebhook != ''
              with:
                  webhook-url: ${{ inputs.buildFeishuWebhook }}
                  msg-type: cardkit
                  cardkit-id: AAq15syMYoq55
                  cardkit-version: 0.0.3
                  content: |
                      title=Xtool ${{ steps.final_version.outputs.FINAL_VERSION }} (${{ inputs.buildStage }}) 开始构建
                      sub_title=构建类型: ${{ inputs.buildStage }}
                      content=${{ steps.message-content.outputs.result }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ inputs.nodeVersion }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: ${{ inputs.pnpmVersion }}

            - name: Get pnpm store directory
              id: pnpm-store
              uses: actions/github-script@v7
              with:
                  script: |
                      const { execSync } = require('child_process')
                      const storePath = execSync('pnpm store path --silent', { encoding: 'utf-8' }).trim()
                      core.exportVariable('STORE_PATH', storePath)
                      console.log(`pnpm store path: ${storePath}`)

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies (安装依赖)
              run: pnpm install

            - name: Build Electron app (构建 Electron 主进程)
              run: pnpm run build:electron
              env:
                  BACKEND_SERVER_URL: ${{ inputs.backendServerUrl }}
                  BYPASS_API_URL: ${{ inputs.bypassApiUrl }}

            - name: Build Renderer (构建渲染进程)
              run: pnpm run build:renderer
              env:
                  BACKEND_SERVER_URL: ${{ inputs.backendServerUrl }}
                  BYPASS_API_URL: ${{ inputs.bypassApiUrl }}
                  BUILD_STAGE: ${{ inputs.buildStage }}

            - name: Configure update URL (配置更新 URL 和文件名)
              id: configure_build
              uses: actions/github-script@v7
              env:
                  BUILD_STAGE: ${{ inputs.buildStage }}
                  BUCKET: ${{ inputs.bucket }}
                  AWS_PATH: ${{ inputs.awsPath }}
              with:
                  script: |
                      const fs = require('fs')
                      const packageJson = require('./package.json')

                      const buildStage = process.env.BUILD_STAGE
                      const bucket = process.env.BUCKET
                      const awsPath = process.env.AWS_PATH

                      // 根据环境设置更新 URL 和文件名
                      const s3Dir = buildStage === 'product' ? 'releases' : 'releases-beta'
                      const channel = buildStage === 'product' ? 'latest' : 'beta'
                      const fileSuffix = buildStage === 'product' ? '' : '-beta'

                      // 设置 publish 配置
                      packageJson.build.publish = [{
                        provider: 'generic',
                        url: `https://${bucket}.s3.amazonaws.com/${awsPath}/${s3Dir}`,
                        channel: channel
                      }]

                      // 设置文件名格式（Beta 版本带 -beta 后缀）
                      packageJson.build.nsis.artifactName = `\${productName}-\${version}${fileSuffix}-Setup.\${ext}`

                      fs.writeFileSync('./package.json', JSON.stringify(packageJson, null, 2))

                      // 输出文件名后缀供后续步骤使用
                      core.setOutput('FILE_SUFFIX', fileSuffix)

                      console.log(`更新 URL: https://${bucket}.s3.amazonaws.com/${awsPath}/${s3Dir}`)
                      console.log(`Channel: ${channel}`)
                      console.log(`文件名后缀: ${fileSuffix}`)

            - name: Package with electron-builder (打包)
              run: pnpm exec electron-builder --win --x64
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  BACKEND_SERVER_URL: ${{ inputs.backendServerUrl }}
                  BYPASS_API_URL: ${{ inputs.bypassApiUrl }}

            - name: Post Build Result Message (发送构建结果飞书通知)
              uses: Comori/feishu@v0.0.5
              if: always() && inputs.buildFeishuWebhook != ''
              with:
                  webhook-url: ${{ inputs.buildFeishuWebhook }}
                  msg-type: cardkit
                  cardkit-id: AAq15syMYoq55
                  cardkit-version: 0.0.3
                  content: |
                      title=Xtool ${{ steps.final_version.outputs.FINAL_VERSION }} (${{ inputs.buildStage }}) ${{ job.status }}
                      sub_title=构建类型: ${{ inputs.buildStage }}
                      content=${{ steps.message-content.outputs.result }}

            - name: Upload artifacts (上传构建产物)
              uses: actions/upload-artifact@v4
              with:
                  name: windows-installer-${{ steps.final_version.outputs.FINAL_VERSION }}${{ steps.configure_build.outputs.FILE_SUFFIX }}
                  path: |
                      dist/Xtool-${{ steps.final_version.outputs.FINAL_VERSION }}${{ steps.configure_build.outputs.FILE_SUFFIX }}-Setup.exe
                      dist/*.yml
                  retention-days: 7

    publish:
        permissions:
            contents: write
            pull-requests: read
        runs-on: ubuntu-latest
        needs: [build-electron]
        steps:
            - name: Checkout code (检出代码)
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.patToken }}
                  fetch-depth: 0

            - name: Get version from previous job
              id: get_version
              uses: actions/github-script@v7
              with:
                  script: |
                      const version = require('./package.json').version
                      core.setOutput('VERSION', version)
                      console.log(`版本: ${version}`)

            - name: Determine S3 directory
              id: s3_dir
              uses: actions/github-script@v7
              env:
                  BUILD_STAGE: ${{ inputs.buildStage }}
              with:
                  script: |
                      const buildStage = process.env.BUILD_STAGE

                      if (buildStage === 'product') {
                        core.setOutput('S3_DIR', 'releases')
                        core.setOutput('YML_FILE', 'latest.yml')
                        core.setOutput('FILE_SUFFIX', '')
                      } else {
                        core.setOutput('S3_DIR', 'releases-beta')
                        core.setOutput('YML_FILE', 'beta.yml')
                        core.setOutput('FILE_SUFFIX', '-beta')
                      }

            - name: Download artifacts (下载构建产物)
              uses: actions/download-artifact@v4
              with:
                  merge-multiple: true
                  path: ./releases

            - name: List downloaded files
              run: |
                  echo "Downloaded files:"
                  ls -la ./releases/

            - name: Get PR notes (获取 PR 更新说明)
              id: pr_notes
              uses: actions/github-script@v7
              with:
                  result-encoding: string
                  script: |
                      let notes = '';

                      // 尝试从关联的 PR 获取 body
                      try {
                        const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          commit_sha: context.sha
                        });

                        if (prs.length > 0 && prs[0].body && prs[0].body.trim().length > 0) {
                          notes = prs[0].body.trim();
                        }
                      } catch (error) {
                        console.log(`获取 PR notes 失败: ${error.message}`);
                      }

                      // 如果没有从 PR 获取到，使用默认值
                      if (!notes || notes.length === 0) {
                        notes = '优化已知问题';
                      }

                      return notes;

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.awsAccessKey }}
                  aws-secret-access-key: ${{ secrets.awsSecretKey }}
                  aws-region: ${{ inputs.awsRegion }}

            - name: Upload to AWS S3 (上传到 S3)
              run: |
                  # 上传安装包
                  aws s3 cp "./releases/Xtool-${{ steps.get_version.outputs.VERSION }}${{ steps.s3_dir.outputs.FILE_SUFFIX }}-Setup.exe" \
                    "s3://${{ inputs.bucket }}/${{ inputs.awsPath }}/${{ steps.s3_dir.outputs.S3_DIR }}/Xtool-${{ steps.get_version.outputs.VERSION }}${{ steps.s3_dir.outputs.FILE_SUFFIX }}-Setup.exe" \
                    --acl public-read

                  # 根据发布类型上传 yml 文件
                  if [ "${{ inputs.buildStage }}" == "product" ]; then
                    aws s3 cp "./releases/latest.yml" \
                      "s3://${{ inputs.bucket }}/${{ inputs.awsPath }}/${{ steps.s3_dir.outputs.S3_DIR }}/latest.yml" \
                      --acl public-read
                  else
                    # Beta 环境上传 beta.yml
                    aws s3 cp "./releases/beta.yml" \
                      "s3://${{ inputs.bucket }}/${{ inputs.awsPath }}/${{ steps.s3_dir.outputs.S3_DIR }}/beta.yml" \
                      --acl public-read
                  fi

            - name: Generate download URL
              id: download_url
              uses: actions/github-script@v7
              env:
                  BUCKET: ${{ inputs.bucket }}
                  AWS_PATH: ${{ inputs.awsPath }}
                  S3_DIR: ${{ steps.s3_dir.outputs.S3_DIR }}
                  VERSION: ${{ steps.get_version.outputs.VERSION }}
                  FILE_SUFFIX: ${{ steps.s3_dir.outputs.FILE_SUFFIX }}
              with:
                  script: |
                      const { BUCKET, AWS_PATH, S3_DIR, VERSION, FILE_SUFFIX } = process.env
                      const url = `https://${BUCKET}.s3.amazonaws.com/${AWS_PATH}/${S3_DIR}/Xtool-${VERSION}${FILE_SUFFIX}-Setup.exe`
                      core.setOutput('DOWNLOAD_URL', url)
                      console.log(`下载链接: ${url}`)

            - uses: actions/github-script@v7
              id: release-message-content
              env:
                  VERSION: ${{ steps.get_version.outputs.VERSION }}
                  DOWNLOAD_URL: ${{ steps.download_url.outputs.DOWNLOAD_URL }}
                  PR_NOTES: ${{ steps.pr_notes.outputs.result }}
                  BUILD_STAGE: ${{ inputs.buildStage }}
              with:
                  result-encoding: json
                  script: |
                      const version = process.env.VERSION
                      const downloadUrl = process.env.DOWNLOAD_URL
                      const prNotes = process.env.PR_NOTES
                      const buildStage = process.env.BUILD_STAGE

                      const typeLabel = buildStage === 'product' ? '正式版' : 'Beta 测试版'

                      return `**发布类型**\n${typeLabel}\n\n**更新内容**\n${prNotes}\n\n**下载链接**\n[Windows 安装包](${downloadUrl})`

            - name: Post Release Message (发送发布成功飞书通知)
              uses: Comori/feishu@v0.0.5
              if: success() && inputs.releaseFeishuWebhook != ''
              with:
                  webhook-url: ${{ inputs.releaseFeishuWebhook }}
                  msg-type: cardkit
                  cardkit-id: AAq15syMYoq55
                  cardkit-version: 0.0.3
                  content: |
                      title=Xtool ${{ steps.get_version.outputs.VERSION }} (${{ inputs.buildStage }}) 发布成功
                      content=${{ steps.release-message-content.outputs.result }}

            - name: Create GitHub Release (创建 GitHub Release - 仅 Production)
              if: success() && inputs.buildStage == 'product'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.get_version.outputs.VERSION }}
                  name: v${{ steps.get_version.outputs.VERSION }}
                  body: ${{ steps.pr_notes.outputs.result }}
                  files: |
                      ./releases/Xtool-${{ steps.get_version.outputs.VERSION }}-Setup.exe
                      ./releases/latest.yml
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.patToken }}

            - name: Create GitHub Tag (创建 GitHub Tag - 仅 Production)
              if: success() && inputs.buildStage == 'product'
              uses: actions/github-script@v7
              env:
                  VERSION: ${{ steps.get_version.outputs.VERSION }}
              with:
                  github-token: ${{ secrets.patToken }}
                  script: |
                      const version = process.env.VERSION
                      const tagName = `v${version}`
                      const ref = `refs/tags/${tagName}`

                      console.log(`开始创建 tag: ${tagName}`)

                      // 检查 tag 是否已存在
                      try {
                          await github.rest.git.getRef({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              ref: `tags/${tagName}`
                          })
                          console.log(`Tag ${tagName} 已存在，跳过创建`)
                          return
                      } catch (error) {
                          if (error.status !== 404) {
                              throw error
                          }
                      }

                      // 创建 tag
                      try {
                          await github.rest.git.createRef({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              ref: ref,
                              sha: context.sha
                          })
                          console.log(`成功创建 tag: ${tagName}`)
                      } catch (error) {
                          if (error.status === 422) {
                              console.log(`Tag ${tagName} 已存在，跳过创建`)
                          } else {
                              throw error
                          }
                      }
